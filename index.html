TYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Galpón</title>
    <meta name="theme-color" content="#2563eb"/>
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1.5rem; margin-bottom: 1.5rem; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; color: white; transition: background-color 0.3s; cursor: pointer; text-align: center; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <!-- Contenido de la aplicación (igual que antes) -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
         <header class="text-center mb-8"><h1 class="text-3xl md:text-4xl font-bold text-gray-900">Registro de Galpón de Pollos</h1><p class="text-gray-600 mt-2">Una herramienta para automatizar la gestión diaria.</p></header>
        <main>
            <div class="card grid md:grid-cols-2 gap-6 items-center">
                <div><h2 class="text-xl font-bold">Inventario de Alimento</h2><p class="text-5xl font-bold text-blue-600 mt-2" id="inventory-display">0</p><p class="text-gray-500">Bultos disponibles</p></div>
                <div class="flex flex-col items-start"><label for="add-stock" class="font-semibold">Añadir Bultos al Inventario:</label><div class="flex mt-2 w-full"><input type="number" id="add-stock" class="input-field rounded-r-none" placeholder="Ej: 10"><button id="add-stock-btn" class="btn bg-blue-600 hover:bg-blue-700 rounded-l-none">Añadir</button></div></div>
            </div>
            <div class="card">
                <h2 class="text-xl font-bold mb-4">Nuevo Registro Diario</h2>
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div><label for="record-date" class="font-semibold">Fecha</label><input type="date" id="record-date" class="input-field"></div>
                    <div><label for="avg-weight" class="font-semibold">Peso Promedio (g)</label><input type="number" id="avg-weight" class="input-field" placeholder="Ej: 1500"></div>
                    <div><label for="mortality" class="font-semibold">Mortalidad (aves)</label><input type="number" id="mortality" class="input-field" placeholder="Ej: 5"></div>
                    <div><label for="consumption" class="font-semibold">Consumo (bultos)</label><input type="number" id="consumption" class="input-field" placeholder="Ej: 2"></div>
                </div>
                <button id="save-record-btn" class="btn bg-blue-600 hover:bg-blue-700 mt-6 w-full md:w-auto">Guardar Registro del Día</button>
            </div>
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4"><h2 class="text-xl font-bold">Historial de Registros</h2></div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white"><thead class="bg-gray-200"><tr><th class="py-3 px-4 text-left font-semibold">Fecha</th><th class="py-3 px-4 text-left font-semibold">Peso Promedio (g)</th><th class="py-3 px-4 text-left font-semibold">Mortalidad</th><th class="py-3 px-4 text-left font-semibold">Consumo (bultos)</th><th class="py-3 px-4 text-left font-semibold">Acciones</th></tr></thead><tbody id="records-table-body"></tbody></table>
                    <p id="no-records-message" class="text-center text-gray-500 py-8">Aún no hay registros guardados.</p>
                </div>
            </div>
        </main>
        <div id="message-box" class="fixed bottom-5 left-1/2 -translate-x-1/2 hidden px-8 py-3 rounded-lg text-white font-medium"></div>
        <footer class="text-center mt-8 text-sm text-gray-500"><p>ID de Sesión: <span id="session-id" class="font-mono"></span></p></footer>
    </div>
    <script type="module">
        // El código JavaScript es el mismo que en la versión anterior
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-shed-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let userId = null;
        const inventoryDisplay = document.getElementById('inventory-display'), addStockInput = document.getElementById('add-stock'), addStockBtn = document.getElementById('add-stock-btn'), dateInput = document.getElementById('record-date'), avgWeightInput = document.getElementById('avg-weight'), mortalityInput = document.getElementById('mortality'), consumptionInput = document.getElementById('consumption'), saveRecordBtn = document.getElementById('save-record-btn'), recordsTableBody = document.getElementById('records-table-body'), noRecordsMessage = document.getElementById('no-records-message'), messageBox = document.getElementById('message-box'), sessionIdDisplay = document.getElementById('session-id');
        function showMessage(text, type = 'success') { messageBox.textContent = text; messageBox.className = `fixed bottom-5 left-1/2 -translate-x-1/2 px-8 py-3 rounded-lg text-white font-medium ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; messageBox.style.display = 'block'; setTimeout(() => { messageBox.style.display = 'none'; }, 3000); }
        function renderTable(records) { recordsTableBody.innerHTML = ''; const sortedRecords = records.sort((a, b) => new Date(b.date) - new Date(a.date)); if (sortedRecords.length === 0) { noRecordsMessage.style.display = 'block'; recordsTableBody.style.display = 'none'; } else { noRecordsMessage.style.display = 'none'; recordsTableBody.style.display = ''; sortedRecords.forEach(record => { const row = document.createElement('tr'); row.className = 'border-b hover:bg-gray-50'; row.innerHTML = `<td class="py-3 px-4">${record.date}</td><td class="py-3 px-4">${record.avg_weight_g}</td><td class="py-3 px-4">${record.mortality_count}</td><td class="py-3 px-4">${record.food_consumed_bags}</td><td class="py-3 px-4"><button class="text-red-600 hover:text-red-800 font-semibold" data-id="${record.id}" data-consumption="${record.food_consumed_bags}">Eliminar</button></td>`; recordsTableBody.appendChild(row); }); } window.recordsData = sortedRecords; }
        async function addStock() { if (!userId) { showMessage('Error: ID de usuario no disponible.', 'error'); return; } const amount = parseInt(addStockInput.value, 10); if (isNaN(amount) || amount <= 0) { showMessage('Por favor, introduce una cantidad válida.', 'error'); return; } const inventoryRef = doc(db, `artifacts/${appId}/users/${userId}/shed_inventory/main`); try { await runTransaction(db, async (transaction) => { const inventoryDoc = await transaction.get(inventoryRef); const newStock = (inventoryDoc.exists() ? inventoryDoc.data().current_bags : 0) + amount; transaction.set(inventoryRef, { current_bags: newStock }, { merge: true }); }); showMessage(`${amount} bulto(s) añadido(s) al inventario.`, 'success'); addStockInput.value = ''; } catch (error) { console.error("Error al añadir stock:", error); showMessage('Error al actualizar el inventario.', 'error'); } }
        async function saveRecord() { if (!userId) { showMessage('Error: ID de usuario no disponible.', 'error'); return; } const record = { date: dateInput.value, avg_weight_g: parseInt(avgWeightInput.value, 10), mortality_count: parseInt(mortalityInput.value, 10), food_consumed_bags: parseInt(consumptionInput.value, 10), }; if (!record.date || isNaN(record.avg_weight_g) || isNaN(record.mortality_count) || isNaN(record.food_consumed_bags)) { showMessage('Todos los campos son obligatorios y deben ser números.', 'error'); return; } if (record.avg_weight_g < 0 || record.mortality_count < 0 || record.food_consumed_bags < 0) { showMessage('Los valores no pueden ser negativos.', 'error'); return; } const inventoryRef = doc(db, `artifacts/${appId}/users/${userId}/shed_inventory/main`); const recordRef = doc(db, `artifacts/${appId}/users/${userId}/shed_records`, record.date); try { await runTransaction(db, async (transaction) => { const inventoryDoc = await transaction.get(inventoryRef); const recordDoc = await transaction.get(recordRef); if (recordDoc.exists()) throw new Error(`Ya existe un registro para la fecha ${record.date}.`); const currentStock = inventoryDoc.exists() ? inventoryDoc.data().current_bags : 0; if (currentStock < record.food_consumed_bags) throw new Error('No hay suficiente alimento en el inventario.'); transaction.update(inventoryRef, { current_bags: currentStock - record.food_consumed_bags }); transaction.set(recordRef, { ...record, createdAt: serverTimestamp() }); }); showMessage('Registro guardado y inventario actualizado.', 'success'); avgWeightInput.value = ''; mortalityInput.value = ''; consumptionInput.value = ''; } catch (error) { console.error("Error al guardar registro:", error); showMessage(error.message, 'error'); } }
        async function deleteRecord(recordId, consumption) { if (!userId || !recordId) return; const recordRef = doc(db, `artifacts/${appId}/users/${userId}/shed_records`, recordId); const inventoryRef = doc(db, `artifacts/${appId}/users/${userId}/shed_inventory/main`); try { await runTransaction(db, async (transaction) => { const inventoryDoc = await transaction.get(inventoryRef); if (inventoryDoc.exists()) { transaction.update(inventoryRef, { current_bags: (inventoryDoc.data().current_bags || 0) + parseInt(consumption, 10) }); } transaction.delete(recordRef); }); showMessage('Registro eliminado y stock devuelto al inventario.', 'success'); } catch (error) { console.error("Error al eliminar el registro: ", error); showMessage('No se pudo eliminar el registro.', 'error'); } }
        function setupListenersAndData(currentUserId) { userId = currentUserId; sessionIdDisplay.textContent = userId; const inventoryRef = doc(db, `artifacts/${appId}/users/${userId}/shed_inventory/main`); onSnapshot(inventoryRef, (doc) => { inventoryDisplay.textContent = doc.exists() ? doc.data().current_bags : 0; }); const recordsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/shed_records`)); onSnapshot(recordsQuery, (querySnapshot) => { const records = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); renderTable(records); }); }
        window.onload = () => { dateInput.value = new Date().toISOString().slice(0, 10); const urlParams = new URLSearchParams(window.location.search); const userIdFromUrl = urlParams.get('user'); if (userIdFromUrl) { setupListenersAndData(userIdFromUrl); } else { onAuthStateChanged(auth, (user) => { if (user) { setupListenersAndData(user.uid); } }); (async () => { try { if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) { await signInWithCustomToken(auth, __initial_auth_token); } else { await signInAnonymously(auth); } } catch (error) { console.error("Error de autenticación:", error); } })(); } addStockBtn.addEventListener('click', addStock); saveRecordBtn.addEventListener('click', saveRecord); recordsTableBody.addEventListener('click', (e) => { if (e.target && e.target.matches('button[data-id]')) { const recordId = e.target.getAttribute('data-id'); const consumption = e.target.getAttribute('data-consumption'); if (confirm(`¿Estás seguro de que quieres eliminar el registro del ${recordId}?`)) { deleteRecord(recordId, consumption); } } }); if ('serviceWorker' in navigator) { navigator.serviceWorker.register('/service-worker.js').then(reg => console.log('Service Worker registered!', reg)).catch(err => console.log('Error registering Service Worker', err)); } };
    </script>
</body>
</html>
